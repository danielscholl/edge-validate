# Instructions for Setting up Key Vault


Create a Key Vault with a User Managed Identity access policy

```bash
VAULT_NAME="azure-k8s-vault"
RESOURCE_GROUP="azure-k8s"
LOCATION="eastus"

# Create Key Vault
az keyvault create --name $VAULT_NAME --resource-group $RESOURCE_GROUP --location $LOCATION

# Create a Cryptographic Key
az keyvault key create --name sops-key --vault-name $VAULT_NAME --protection software --ops encrypt decrypt

# Create a User Managed Identity
POD_IDENTITY_NAME="kv-access-identity"
az identity create -n $POD_IDENTITY_NAME -g $RESOURCE_GROUP -l $LOCATION
POD_IDENTITY_OID=$(az identity show -n $POD_IDENTITY_NAME -g $RESOURCE_GROUP -o tsv --query "principalId")
POD_IDENTITY_ID=$(az identity show -n $POD_IDENTITY_NAME -g $RESOURCE_GROUP -o tsv --query "id")
POD_IDENTITY_CLIENT_ID=$(az identity show -n $POD_IDENTITY_NAME -g $RESOURCE_GROUP -o tsv --query "clientId")

# Add Access Policy for Managed Identity
az keyvault set-policy --name $VAULT_NAME --resource-group $RESOURCE_GROUP --object-id $POD_IDENTITY_OID --key-permissions encrypt decrypt

# Install the Sops Identity
cat > ./clusters/$AKS_NAME/sops-identity.yaml <<EOF
---
apiVersion: aadpodidentity.k8s.io/v1
kind: AzureIdentity
metadata:
  name: test-identity
  namespace: default
spec:
  clientID: $POD_IDENTITY_CLIENT_ID
  resourceID: $POD_IDENTITY_ID
  type: 0 # user-managed identity
---
apiVersion: aadpodidentity.k8s.io/v1
kind: AzureIdentityBinding
metadata:
  name: test-identity-binding
  namespace: default
spec:
  azureIdentity: test-identity
  selector: test-identity
EOF

# Update the Git Repo
git add ./clusters/$AKS_NAME/sops-identity.yaml && git commit -m "Installing KV SOPS Pod Identity" && git push

# Validate the Deployment
flux reconcile kustomization flux-system --with-source
```