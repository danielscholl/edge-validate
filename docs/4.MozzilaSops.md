# Install Mozilla SOPS: Secrets OPerationS

[Documentation](https://github.com/mozilla/sops)
[Sample](https://github.com/adrianmo/aks-flux)


Patch the kustomize-controller Pod template to match the AzureIdentity name label and allow binding.

```bash
# Create the Patch
cat > ./clusters/$AKS_NAME/flux-system/gotk-patches.yaml <<EOF
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kustomize-controller
  namespace: flux-system
spec:
  template:
    metadata:
      labels:
        aadpodidbinding: edge-identity  # match the AzureIdentityBinding selector
    spec:
      containers:
      - name: manager
        env:
        - name: AZURE_AUTH_METHOD
          value: msi
EOF

# Update Kustomization
cat > ./clusters/$AKS_NAME/flux-system/kustomization.yaml <<EOF
---
kind: Kustomization
resources:
  - gotk-components.yaml
  - gotk-sync.yaml
patchesStrategicMerge:
  - gotk-patches.yaml
EOF


# Add the spec.decryption block to the demoapp-kustomization
cat > ./clusters/$AKS_NAME/demoapp-kustomization.yaml <<EOF
---
apiVersion: kustomize.toolkit.fluxcd.io/v1beta1
kind: Kustomization
metadata:
  name: demoapp
  namespace: flux-system
spec:
  interval: 5m0s
  path: ./manifests
  prune: true
  sourceRef:
    kind: GitRepository
    name: flux-system
  validation: client
  decryption:
    provider: sops
EOF
```