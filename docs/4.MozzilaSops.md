# Install Mozilla SOPS: Secrets OPerationS

[Documentation](https://github.com/mozilla/sops)
[Sample](https://github.com/adrianmo/aks-flux)


Patch the kustomize-controller Pod template to match the AzureIdentity name label and allow binding.

```bash
# Create the Patch
cat > ./clusters/$AKS_NAME/flux-system/gotk-patches.yaml <<EOF
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kustomize-controller
  namespace: flux-system
spec:
  template:
    metadata:
      labels:
        aadpodidbinding: sops-akv-decryptor  # match the AzureIdentityBinding selector
    spec:
      containers:
      - name: manager
        env:
        - name: AZURE_AUTH_METHOD
          value: msi
EOF

# Update Kustomization
cat > ./clusters/$AKS_NAME/flux-system/kustomization.yaml <<EOF
---
kind: Kustomization
resources:
  - gotk-components.yaml
  - gotk-sync.yaml
patchesStrategicMerge:
  - gotk-patches.yaml
EOF

# Update the Git Repo to deploy
git add ./clusters/$AKS_NAME/flux-system && git commit -m "Flux Controller Patch" && git push

# Validate the Deployment
flux reconcile kustomization flux-system --with-source
kubectl describe Kustomization flux-system -n flux-system
```
