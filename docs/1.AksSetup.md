# Setup an AKS CLuster

> This uses the Preview for [Bring Your Own Identity](https://docs.microsoft.com/en-us/azure/aks/use-managed-identity).

Prepare Azure CLI

```bash
az login
az account set --subscription <your_subscription>
az extension add --name aks-preview
```


Create Cluster Managed Identities

```bash
RESOURCE_GROUP="azure-k8s"
LOCATION="eastus"

# Create Resource Group
az group create -n $RESOURCE_GROUP -l $LOCATION

# Create User Assigned Identity
IDENTITY_NAME="aks-controlplane-identity"
az identity create -n $IDENTITY_NAME -g $RESOURCE_GROUP -l $LOCATION
IDENTITY_ID=$(az identity show -n $IDENTITY_NAME -g $RESOURCE_GROUP -o tsv --query "id")

# Create Kubelet Identity
KUBELET_IDENTITY_NAME="aks-kubelet-identity"
az identity create -n $KUBELET_IDENTITY_NAME -g $RESOURCE_GROUP -l $LOCATION
KUBELET_IDENTITY_ID=$(az identity show -n $KUBELET_IDENTITY_NAME -g $RESOURCE_GROUP -o tsv --query "id")
KUBELET_IDENTITY_OID=$(az identity show -n $KUBELET_IDENTITY_NAME -g $RESOURCE_GROUP -o tsv --query "principalId")
```


Provision a basic AKS Cluster 

```bash
RESOURCE_GROUP="azure-k8s"
AKS_NAME="azure-k8s"
LOCATION="eastus"

# Create Cluster
az aks create -g $RESOURCE_GROUP -n $AKS_NAME --enable-managed-identity --assign-identity $IDENTITY_ID --assign-kubelet-identity $KUBELET_IDENTITY_ID --generate-ssh-keys

# Get Credentials
az aks get-credentials -g $RESOURCE_GROUP -n $AKS_NAME
```


Allow Kubelet Identity access to Resource Group

```bash
# Allow Kubelet "Virtual Machine Contributor" required by AAD Pod Identity
RESOURCE_GROUP_ID=$(az group show -n $RESOURCE_GROUP -o tsv --query id)
AKS_RESOURCE_GROUP_NAME=$(az aks show -g $RESOURCE_GROUP -n $AKS_NAME -o tsv --query nodeResourceGroup)
AKS_RESOURCE_GROUP_ID=$(az group show -n $AKS_RESOURCE_GROUP_NAME -o tsv --query id)
KUBELET_CLIENT_ID=$(az aks show -g $RESOURCE_GROUP -n $AKS_NAME -o tsv --query identityProfile.kubeletidentity.clientId)

az role assignment create --role "Virtual Machine Contributor" --assignee $KUBELET_CLIENT_ID --scope $AKS_RESOURCE_GROUP_ID
```


Create a User Managed Identity with 

```bash
POD_IDENTITY_NAME="pod-identity"
RESOURCE_GROUP="azure-k8s"
LOCATION="eastus"

az identity create -n $POD_IDENTITY_NAME -g $RESOURCE_GROUP -l $LOCATION
POD_IDENTITY_OID=$(az identity show -n $POD_IDENTITY_NAME -g $RESOURCE_GROUP -o tsv --query "principalId")
```


Create a Key Vault with a User Managed Identity access policy

```bash
VAULT_NAME="azure-k8s-vault"
RESOURCE_GROUP="azure-k8s"
LOCATION="eastus"

# Create Key Vault
az keyvault create --name $VAULT_NAME --resource-group $RESOURCE_GROUP --location $LOCATION

# Create a Cryptographic Key
az keyvault key create --name sops-key --vault-name $VAULT_NAME --protection software --ops encrypt decrypt

# Create a User Managed Identity
POD_IDENTITY_NAME="kv-access-identity"
az identity create -n $POD_IDENTITY_NAME -g $RESOURCE_GROUP -l $LOCATION
POD_IDENTITY_OID=$(az identity show -n $POD_IDENTITY_NAME -g $RESOURCE_GROUP -o tsv --query "principalId")
POD_IDENTITY_ID=$(az identity show -n $POD_IDENTITY_NAME -g $RESOURCE_GROUP -o tsv --query "id")

# Add Access Policy for Managed Identity
az keyvault set-policy --name $VAULT_NAME --resource-group $RESOURCE_GROUP --object-id $POD_IDENTITY_OID --key-permissions encrypt decrypt
```