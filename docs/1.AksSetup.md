# Setup an AKS CLuster

Provision a basic AKS Cluster to work with

```bash
RESOURCE_GROUP="azure-k8s"
AKS_NAME="azure-k8s"
LOCATION="eastus"

# Create Resource Group
az group create -n $RESOURCE_GROUP -l $LOCATION

# Create Cluster
az aks create -g $RESOURCE_GROUP -n $AKS_NAME --enable-managed-identity

# Get Credentials
az aks get-credentials -g $RESOURCE_GROUP -n $AKS_NAME
```

Assign Kubelet Identity the Proper Roles

```bash
RESOURCE_GROUP="azure-k8s"
LOCATION="eastus"
AKS_NAME="azure-k8s"


# Get Kubelet Identity
RESOURCE_GROUP_ID=$(az group show -n $RESOURCE_GROUP -o tsv --query id)
AKS_RESOURCE_GROUP_NAME=$(az aks show -g $RESOURCE_GROUP -n $AKS_NAME -o tsv --query nodeResourceGroup)
AKS_RESOURCE_GROUP_ID=$(az group show -n $RESOURCE_GROUP -o tsv --query id)
KUBELET_CLIENT_ID=$(az aks show -g $RESOURCE_GROUP -n $AKS_NAME -o tsv --query identityProfile.kubeletidentity.clientId)

# Assign Roles to Kubelet Identity
az role assignment create --role "Virtual Machine Contributor" --assignee $KUBELET_CLIENT_ID --scope $AKS_RESOURCE_GROUP_ID
az role assignment create --role "Managed Identity Operator" --assignee $KUBELET_CLIENT_ID --scope $RESOURCE_GROUP_ID
```


Create a Managed Identity

```bash
IDENTITY_NAME="PodIdentity"
RESOURCE_GROUP="azure-k8s"
LOCATION="eastus"

az identity create -n $IDENTITY_NAME -g $RESOURCE_GROUP -l $LOCATION
IDENTITY_CID=$(az identity show -n $IDENTITY_NAME -g $RESOURCE_GROUP -o tsv --query "clientId")
IDENTITY_OID=$(az identity show -n $IDENTITY_NAME -g $RESOURCE_GROUP -o tsv --query "principalId")
IDENTITY_ID=$(az identity show -n $IDENTITY_NAME -g $RESOURCE_GROUP -o tsv --query "id")
```

Create a Key Vault

```bash
VAULT_NAME="azure-k8s-vault"
RESOURCE_GROUP="azure-k8s"
LOCATION="eastus"

az keyvault create --name $VAULT_NAME --resource-group $RESOURCE_GROUP --location $LOCATION

# Create a Cryptographic Key
az keyvault key create --name sops-key --vault-name $VAULT_NAME --protection software --ops encrypt decrypt

# Add Access Policy for Managed Identity
az keyvault set-policy --name $VAULT_NAME --resource-group $RESOURCE_GROUP --object-id $IDENTITY_OID --key-permissions encrypt decrypt

# Retrieve the Key ID
az keyvault key show --name sops-key --vault-name $VAULT_NAME --query key.kid


```